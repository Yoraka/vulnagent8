# Apache Sling Servlets Resolver 攻击面调查计划（白盒审计版）

## 引言/概述

基于对《部署架构报告》的分析以及对项目技术栈的深入了解，本调查计划针对 **Apache Sling Servlets Resolver** OSGi Bundle 制定详细的白盒代码审计策略。

### 项目类型判断与审计策略

**项目类型**: **底层基础组件** - Apache Sling Servlets Resolver 是一个核心的 OSGi Bundle，负责 Servlet 和 Script 的解析、路由以及错误处理。它是 Apache Sling 框架的关键基础设施组件。

**审计策略重点**:
- **主要关注：主动缺陷** - 重点挖掘核心解析算法、路径处理逻辑、资源访问控制等可能导致 CVE 级别漏洞的代码缺陷
- **次要关注：被动缺失/选择** - 记录默认配置的安全风险、API 设计的潜在滥用点等作为安全加固建议

**审计依据**:
- 项目是处理外部请求路径解析的核心组件，直接影响请求路由和资源访问
- 作为底层组件，其安全缺陷可能影响所有依赖它的上层应用
- OSGi 环境下的服务注册和依赖注入机制需要特别关注权限边界

### 技术栈概况
- **语言**: Java 17
- **框架**: Apache Sling, OSGi Framework
- **构建**: Maven
- **核心功能**: ServletResolver、SlingScriptResolver、ErrorHandler
- **运行环境**: OSGi 容器（如 Apache Felix）

## 详细检查项列表

### 核心解析与路由模块

- [x] **CODE-REVIEW-ITEM-001: 核心 Servlet 解析器安全审计**
    * **目标代码/配置区域**: 
        * `org.apache.sling.servlets.resolver.internal.SlingServletResolver.java`
        * `ServletResourceCollector.java` 和相关的资源收集类
        * `PathBasedServletAcceptor.java` 路径匹配逻辑
    * **要审计的潜在风险/漏洞类型**: 
        1. **主动缺陷**: 路径遍历漏洞 - 恶意构造的请求路径绕过访问控制
        2. **主动缺陷**: 路径规范化绕过 - 使用 `../`、`./`、URL编码等绕过路径检查
        3. **主动缺陷**: 路径注入攻击 - 通过特殊字符注入恶意路径组件
    * **建议的白盒代码审计方法/关注点**: 
        1. 跟踪请求路径从输入到解析的完整流程，确认每个规范化和验证步骤
        2. 检查路径分割、连接、比较算法的边界条件处理
        3. 验证对各种编码格式（URL编码、Unicode等）的处理是否安全
        4. 审查路径黑名单/白名单机制的完整性和绕过可能性
    * **部署上下文与优先级**: 这是整个 Servlet 解析的核心入口，影响所有请求路由。优先级：**极高**

- [ ] **CODE-REVIEW-ITEM-002: Script 资源解析器安全审计**
    * **目标代码/配置区域**: 
        * `ScriptResourceResolver.java` - 脚本资源定位逻辑
        * `ScriptResource.java` - 脚本资源封装
        * `NamedScriptResourceCollector.java` - 命名脚本收集
    * **要审计的潜在风险/漏洞类型**: 
        1. **主动缺陷**: 脚本路径注入导致任意脚本执行
        2. **主动缺陷**: 脚本扩展名绕过导致非预期脚本类型执行
        3. **主动缺陷**: 缓存污染攻击，通过恶意脚本影响后续请求
    * **建议的白盒代码审计方法/关注点**: 
        1. 审查脚本路径构建逻辑，确认无法注入恶意路径
        2. 检查扩展名验证机制，确保只执行允许的脚本类型
        3. 分析脚本缓存机制的键生成和失效逻辑
        4. 验证脚本资源的访问权限检查是否充分
    * **部署上下文与优先级**: 脚本解析直接关系到代码执行安全。优先级：**极高**

- [ ] **CODE-REVIEW-ITEM-003: 资源提供者工厂安全审计**
    * **目标代码/配置区域**: 
        * `ServletResourceProviderFactory.java` - 资源提供者工厂
        * `ServletResourceProvider.java` - 资源提供者实现
        * `MergingServletResourceProvider.java` - 合并资源提供者
    * **要审计的潜在风险/漏洞类型**: 
        1. **主动缺陷**: 资源提供者注册绕过，恶意注册虚假资源提供者
        2. **主动缺陷**: 资源权限检查不足，访问未授权资源
        3. **主动缺陷**: 合并逻辑错误导致权限提升或信息泄露
    * **建议的白盒代码审计方法/关注点**: 
        1. 审查资源提供者的注册和验证机制
        2. 检查资源访问的权限校验逻辑
        3. 分析合并多个资源提供者时的优先级和冲突处理
        4. 验证资源元数据的完整性检查
    * **部署上下文与优先级**: 资源提供者控制底层资源访问。优先级：**高**

### 错误处理与安全边界

- [ ] **CODE-REVIEW-ITEM-004: 错误处理器安全审计**
    * **目标代码/配置区域**: 
        * `SlingErrorHandlerImpl.java` - 错误处理器核心实现
        * `HandleErrorSlingHttpServletResponse.java` - 错误响应处理
        * 所有异常处理和错误页面渲染代码
    * **要审计的潜在风险/漏洞类型**: 
        1. **主动缺陷**: 错误信息泄露 - 敏感信息通过错误消息暴露
        2. **主动缺陷**: 异常处理绕过 - 通过触发异常绕过安全检查
        3. **主动缺陷**: 错误页面注入 - 在错误消息中注入恶意内容
    * **建议的白盒代码审计方法/关注点**: 
        1. 检查所有异常捕获和错误信息生成的代码路径
        2. 验证错误消息是否过度暴露系统内部信息
        3. 审查错误响应的内容类型和编码处理
        4. 确认异常处理不会导致安全检查的绕过
    * **部署上下文与优先级**: 错误处理影响信息泄露和安全绕过风险。优先级：**高**

- [ ] **CODE-REVIEW-ITEM-005: 请求过滤器和包装器安全审计**
    * **目标代码/配置区域**: 
        * `ServletWrapperUtil.java` - Servlet 包装工具
        * 所有实现 Filter 或包装 Request/Response 的类
        * 请求预处理和后处理逻辑
    * **要审计的潜在风险/漏洞类型**: 
        1. **主动缺陷**: 请求参数篡改 - 包装器修改了安全相关参数
        2. **主动缺陷**: 响应头注入 - 通过包装器注入恶意响应头
        3. **主动缺陷**: 状态信息泄露 - 包装器暴露了内部状态信息
    * **建议的白盒代码审计方法/关注点**: 
        1. 审查所有请求/响应包装器的参数修改逻辑
        2. 检查包装器是否正确处理安全相关的头部和参数
        3. 验证包装器的状态管理和清理机制
        4. 确认包装器不会泄露或篡改敏感信息
    * **部署上下文与优先级**: 请求处理的安全边界控制。优先级：**中高**

### 配置与权限管理

- [ ] **CODE-REVIEW-ITEM-006: OSGi 配置安全审计**
    * **目标代码/配置区域**: 
        * `ResolverConfig.java` - 解析器配置
        * 所有 OSGi 配置相关的注解和处理
        * `org.apache.sling.servlets.resolver.SlingServletResolver` 配置
    * **要审计的潜在风险/漏洞类型**: 
        1. **被动缺失**: 默认配置过于宽松，如执行路径设置为根路径
        2. **主动缺陷**: 配置验证不足，恶意配置导致安全绕过
        3. **被动缺失**: 缺乏足够的配置选项来限制恶意行为
    * **建议的白盒代码审计方法/关注点**: 
        1. 审查所有默认配置值的安全影响
        2. 检查配置参数的验证和范围限制
        3. 验证配置更新时的权限检查
        4. 分析配置文档是否充分警告安全风险
    * **部署上下文与优先级**: 配置安全影响整体系统安全基线。优先级：**中高**

- [ ] **CODE-REVIEW-ITEM-007: OSGi 服务依赖注入安全审计**
    * **目标代码/配置区域**: 
        * 所有使用 `@Reference`、`@Inject` 注解的服务依赖
        * OSGi 服务注册和获取逻辑
        * Bundle 生命周期管理代码
    * **要审计的潜在风险/漏洞类型**: 
        1. **主动缺陷**: 服务依赖注入攻击 - 恶意服务替换正常依赖
        2. **主动缺陷**: 服务权限绕过 - 通过依赖链绕过权限检查
        3. **主动缺陷**: 循环依赖导致的 DoS 或状态异常
    * **建议的白盒代码审计方法/关注点**: 
        1. 检查关键服务依赖的验证和权限校验
        2. 分析服务注册/注销时的安全检查
        3. 审查服务方法调用的权限传播机制
        4. 验证对恶意或不可用服务的处理逻辑
    * **部署上下文与优先级**: OSGi 环境的服务安全基础。优先级：**中**

### 资源访问与缓存机制

- [ ] **CODE-REVIEW-ITEM-008: 资源缓存机制安全审计**
    * **目标代码/配置区域**: 
        * 所有涉及缓存的类和方法
        * 缓存键生成和失效逻辑
        * `ResolverConfig` 中的缓存大小配置
    * **要审计的潜在风险/漏洞类型**: 
        1. **主动缺陷**: 缓存键冲突导致数据泄露或权限绕过
        2. **主动缺陷**: 缓存污染攻击，恶意数据影响后续请求
        3. **主动缺陷**: 缓存失效不当导致陈旧数据和安全策略失效
    * **建议的白盒代码审计方法/关注点**: 
        1. 分析缓存键的生成算法，确保无冲突和唯一性
        2. 检查缓存数据的完整性和有效性验证
        3. 审查缓存失效的触发条件和清理机制
        4. 验证缓存权限检查是否在数据读取时重新执行
    * **部署上下文与优先级**: 缓存机制影响性能和安全一致性。优先级：**中**

- [ ] **CODE-REVIEW-ITEM-009: 路径收集器算法安全审计**
    * **目标代码/配置区域**: 
        * `AbstractResourceCollector.java` - 抽象资源收集器
        * `LocationCollector.java` - 位置收集器
        * `ResourceCollector.java` - 资源收集器
    * **要审计的潜在风险/漏洞类型**: 
        1. **主动缺陷**: 路径收集算法的递归深度攻击导致 DoS
        2. **主动缺陷**: 路径遍历权限检查在收集过程中被绕过
        3. **主动缺陷**: 权重计算错误导致恶意资源优先级提升
    * **建议的白盒代码审计方法/关注点**: 
        1. 检查递归收集的深度限制和终止条件
        2. 审查路径收集过程中的权限检查一致性
        3. 分析权重计算算法的公平性和防篡改性
        4. 验证收集结果的排序和过滤逻辑
    * **部署上下文与优先级**: 路径收集直接影响资源解析结果。优先级：**中**

### 外部接口与边界检查

- [ ] **CODE-REVIEW-ITEM-010: Web Console 插件安全审计**
    * **目标代码/配置区域**: 
        * `WebConsolePlugin.java` - Web 控制台插件
        * 所有管理界面和调试功能
        * 统计信息和状态展示逻辑
    * **要审计的潜在风险/漏洞类型**: 
        1. **主动缺陷**: Web 控制台权限绕过，未授权访问管理功能
        2. **主动缺陷**: 信息泄露，通过控制台暴露敏感配置或状态
        3. **主动缺陷**: 控制台功能被恶意利用进行系统探测
    * **建议的白盒代码审计方法/关注点**: 
        1. 检查控制台访问的权限认证和授权机制
        2. 审查展示信息的敏感性过滤和脱敏处理
        3. 验证控制台功能是否可以被禁用或限制
        4. 分析控制台操作的审计日志和监控机制
    * **部署上下文与优先级**: 管理接口的安全风险需要重点关注。优先级：**中高**

- [ ] **CODE-REVIEW-ITEM-011: 搜索路径提供者安全审计**
    * **目标代码/配置区域**: 
        * `SearchPathProvider.java` - 搜索路径提供者
        * 所有路径搜索和解析逻辑
        * 路径优先级和继承机制
    * **要审计的潜在风险/漏洞类型**: 
        1. **主动缺陷**: 搜索路径注入，通过恶意路径影响搜索结果
        2. **主动缺陷**: 路径优先级操控，恶意路径获得更高优先级
        3. **被动缺失**: 搜索路径配置缺乏足够的安全边界
    * **建议的白盒代码审计方法/关注点**: 
        1. 审查搜索路径的来源验证和白名单机制
        2. 检查路径优先级计算的防篡改措施
        3. 分析搜索路径的权限继承和隔离逻辑
        4. 验证路径搜索的性能限制和 DoS 防护
    * **部署上下文与优先级**: 搜索路径控制资源解析范围。优先级：**中**

### 并发安全与资源管理

- [ ] **CODE-REVIEW-ITEM-012: 多线程并发安全审计**
    * **目标代码/配置区域**: 
        * 所有共享状态和缓存相关的类
        * 线程安全注解和同步机制
        * OSGi 服务的并发访问处理
    * **要审计的潜在风险/漏洞类型**: 
        1. **主动缺陷**: 竞态条件导致缓存一致性问题或权限检查绕过
        2. **主动缺陷**: 死锁或活锁导致服务不可用
        3. **主动缺陷**: 并发访问导致资源状态污染
    * **建议的白盒代码审计方法/关注点**: 
        1. 检查所有共享变量的同步保护机制
        2. 分析锁的获取顺序和死锁预防
        3. 审查线程安全的数据结构使用是否正确
        4. 验证并发场景下的异常处理和资源清理
    * **部署上下文与优先级**: 并发安全影响系统稳定性。优先级：**中**

- [ ] **CODE-REVIEW-ITEM-013: 资源生命周期管理安全审计**
    * **目标代码/配置区域**: 
        * `WeightedResource.java` - 加权资源管理
        * 所有资源创建、使用、销毁的生命周期代码
        * 资源池和连接管理逻辑
    * **要审计的潜在风险/漏洞类型**: 
        1. **主动缺陷**: 资源泄露导致内存耗尽或文件句柄耗尽
        2. **主动缺陷**: 资源释放不当导致敏感数据残留
        3. **主动缺陷**: 资源重用时的状态污染
    * **建议的白盒代码审计方法/关注点**: 
        1. 检查try-with-resources和finally块的资源清理
        2. 审查资源池的大小限制和清理策略
        3. 分析资源重用前的状态重置和清理
        4. 验证异常情况下的资源清理保证
    * **部署上下文与优先级**: 资源管理影响系统稳定性和安全性。优先级：**低**

### 第三方依赖与集成安全

- [ ] **CODE-REVIEW-ITEM-014: 第三方依赖安全审计**
    * **目标代码/配置区域**: 
        * `pom.xml` - Maven 依赖配置
        * `bnd.bnd` - OSGi 导入包配置
        * 所有第三方库的使用和集成点
    * **要审计的潜在风险/漏洞类型**: 
        1. **被动缺失**: 使用存在已知漏洞的第三方依赖版本
        2. **主动缺陷**: 第三方库 API 的不安全使用方式
        3. **被动缺失**: 缺乏依赖的安全更新策略
    * **建议的白盒代码审计方法/关注点**: 
        1. 检查所有依赖的版本和已知安全漏洞
        2. 审查第三方API的调用方式和参数验证
        3. 分析依赖的可选性和降级处理机制
        4. 验证依赖冲突的解决策略
    * **部署上下文与优先级**: 第三方依赖风险需要持续关注。优先级：**中低**

- [ ] **CODE-REVIEW-ITEM-015: 集成测试安全配置审计**
    * **目标代码/配置区域**: 
        * 测试代码中的配置和环境设置
        * 测试数据和模拟对象的安全性
        * 集成测试的权限和隔离机制
    * **要审计的潜在风险/漏洞类型**: 
        1. **被动缺失**: 测试环境配置与生产环境的安全差异
        2. **主动缺陷**: 测试代码中硬编码的敏感信息
        3. **被动缺失**: 测试覆盖不足导致安全漏洞未被发现
    * **建议的白盒代码审计方法/关注点**: 
        1. 检查测试配置文件中的敏感信息处理
        2. 审查测试用例对安全边界的覆盖程度
        3. 分析测试环境的权限配置和数据隔离
        4. 验证测试清理机制防止数据泄露
    * **部署上下文与优先级**: 测试安全有助于提高整体安全质量。优先级：**低**

## 审计执行指导原则

### 主动缺陷检测重点
1. **输入验证缺陷**: 重点关注路径解析、参数处理、配置读取等外部输入处理
2. **权限边界检查**: 审查 OSGi 服务边界、资源访问权限、配置权限等
3. **状态管理缺陷**: 检查缓存逻辑、并发访问、资源生命周期等状态相关代码
4. **错误处理缺陷**: 分析异常路径、错误信息泄露、异常处理绕过等

### 被动缺失评估重点
1. **默认配置安全性**: 评估默认设置对安全的影响
2. **API设计安全性**: 检查API是否容易被错误使用
3. **文档和警告**: 验证安全风险是否有充分提示
4. **安全最佳实践遵循**: 对比业界安全标准和最佳实践

### 审计工具和方法建议
1. **静态代码分析**: 使用 SonarQube、SpotBugs 等工具结合手工审查
2. **依赖漏洞扫描**: 使用 OWASP Dependency Check 检查第三方依赖
3. **代码路径追踪**: 手工追踪关键数据流和控制流
4. **边界条件测试**: 设计测试用例验证边界情况的安全处理

### 优先级执行顺序
1. **极高优先级**: CODE-REVIEW-ITEM-001, 002 (核心解析逻辑)
2. **高优先级**: CODE-REVIEW-ITEM-003, 004, 010 (资源提供、错误处理、管理接口)
3. **中高优先级**: CODE-REVIEW-ITEM-005, 006 (包装器、配置安全)
4. **中优先级**: CODE-REVIEW-ITEM-007, 008, 009, 011, 012 (依赖注入、缓存、路径收集、并发)
5. **中低优先级**: CODE-REVIEW-ITEM-013, 014 (资源管理、第三方依赖)
6. **低优先级**: CODE-REVIEW-ITEM-015 (测试安全)

## 总结

本攻击面调查计划针对 Apache Sling Servlets Resolver 这一底层基础组件的特性，重点关注可能产生直接安全影响的主动缺陷，同时适度关注配置和设计层面的被动安全缺失。计划涵盖了从核心解析逻辑到错误处理、从配置安全到第三方依赖的全方位审计范围，为后续的深入代码审计提供了清晰的路线图和执行指导。