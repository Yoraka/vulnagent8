## 攻击面调查计划 (白盒代码审计导向)

### 引言/概述

本调查计划基于《部署架构报告》的分析结果、用户提供的项目上下文信息（包括但不限于公开暴露端口、多进程架构、容器化配置、VNC/noVNC访问以及已知的pickle反序列化漏洞），以及对项目（Browser Use Web UI）作为“应用层项目”的定性判断。

**审计策略**: 本计划将**同等关注主动缺陷（Active Flaws）和被动缺失/选择（Passive Deficiencies/Design Choices with Security Implications）**。对于应用层项目，代码层面的具体漏洞（如注入、逻辑缺陷）和因配置不当、设计选择或缺乏安全加固措施而引入的风险同样重要。

**项目类型判断**: Browser Use Web UI 是一个典型的应用层项目，它集成了Gradio Web UI、VNC/noVNC服务和浏览器代理功能，直接面向用户或外部系统提供服务。因此，审计需要覆盖其自身代码逻辑、依赖项、以及服务配置的安全性。

**计划检查项数量**: 初步评估，本计划包含大约7-10个核心检查项，力求覆盖关键攻击面。

### 详细检查项 (白盒代码审计)

- [ ] **CODE-REVIEW-ITEM-001: 关键Pickle反序列化漏洞验证与根除 (`update_ui_from_config`)**
    *   **目标代码/配置区域**:
        *   据用户提供信息，主要定位在 `utils` 模块下，与 `update_ui_from_config` 函数或相关接口相关的代码区域。具体文件路径需在代码库中进一步定位 (例如 `src/utils/config_utils.py`, `src/utils/ui_updater.py` 或类似文件)。
        *   所有调用此函数的代码路径，特别注意通过Web UI接口或其他外部可控输入间接触发此函数的路径。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **主动缺陷**: 远程代码执行 (RCE) 通过不安全的pickle反序列化。这是已知的最高优先级风险。
    *   **建议的白盒代码审计方法/关注点**:
        1.  **漏洞确认**: 审计 `update_ui_from_config` 函数，确认其是否直接或间接使用 `pickle.load()` 或 `pickle.loads()` 处理来自不可信来源（如配置文件内容、网络请求、用户输入）的数据。
        2.  **输入溯源**: 详细追踪传递给此函数的数据来源。确定攻击者是否以及如何控制被反序列化的数据。
        3.  **修复方案审查**:
            *   **首选**: 移除pickle的使用，改用更安全的数据交换格式（如JSON）。
            *   **次选 (如果必须用pickle)**: 严格审查是否可以对输入进行签名或强校验以确保其来自可信源，但这通常不是万全之策。
        4.  **影响评估**: 分析成功利用此漏洞可能造成的最大危害，如获取容器控制权等。
    *   **部署上下文与优先级**: 此漏洞若存在且可被外部触发，将直接导致远程代码执行。**优先级：极高**。

- [ ] **CODE-REVIEW-ITEM-002: Web UI (Gradio) 输入验证与输出编码**
    *   **目标代码/配置区域**:
        *   `webui.py` 主应用入口文件。
        *   所有Gradio接口定义文件 (例如用户提到的 `src/webui/interface.py`，以及其他构建Gradio UI元素和处理回调的Python文件)。
        *   所有处理用户输入并将其传递给后端逻辑或在UI中展示的函数。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **主动缺陷**: 跨站脚本 (XSS) - 反射型和存储型（如果输入未正确净化并在UI中显示）。
        2.  **主动缺陷**: 命令注入（如果用户输入被不安全地用于构造系统命令）。
        3.  **主动缺陷**: 服务器端请求伪造 (SSRF) (如果用户输入被用于构造对内部或外部服务的请求)。
        4.  **主动缺陷**: 路径遍历 （如果用户输入用于文件系统操作）。
        5.  **被动缺失**: Gradio组件配置不当，可能导致信息泄露或非预期行为。
    *   **建议的白盒代码审计方法/关注点**:
        1.  审计所有Gradio输入字段的处理逻辑，检查是否对用户输入进行了严格的验证、净化或编码，以防止XSS和注入。
        2.  审查Gradio回调函数，特别是那些接收用户输入并执行后端操作的函数，关注数据如何被使用。
        3.  检查所有将数据显示在UI上的地方，确保执行了恰当的HTML编码。
        4.  Gradio本身可能提供一些安全特性，检查其是否被正确使用。
    *   **部署上下文与优先级**: Web UI (端口 7788) 是主要的用户交互入口。**优先级：高**。

- [ ] **CODE-REVIEW-ITEM-003: noVNC 和 VNC 服务访问控制与认证代码审查**
    *   **目标代码/配置区域**:
        *   `supervisord.conf`中 `x11vnc` 和 `novnc` 进程的启动命令和参数。
        *   VNC密码设置逻辑 (如 `vnc_setup` 脚本或相关代码)。
        *   noVNC代理配置 (如 `./utils/novnc_proxy` 调用的相关代码或其配置机制)。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **被动缺失**: 默认或弱VNC密码，或密码硬编码在代码/配置中 (虽然报告提到 `-rfbauth /root/.vnc/passwd`，但需要检查密码生成和存储的安全性)。
        2.  **主动缺陷/被动缺失**: noVNC代理配置不当，可能绕过认证或暴露过多信息。
        3.  **主动缺陷**: 如果VNC密码设置脚本存在漏洞，可能导致密码泄露或认证绕过。
    *   **建议的白盒代码审计方法/关注点**:
        1.  审查VNC密码的生成、存储和验证机制。确认密码是否足够复杂，是否在安全的位置存储。
        2.  分析noVNC的启动参数和可能的配置文件，检查是否有安全相关选项被错误配置。
        3.  如果noVNC或x11vnc是自定义编译或修改的版本，需要对其源码进行更深入的审查。
        4.  检查 `/root/.vnc/passwd` 文件的权限和生成方式。
    *   **部署上下文与优先级**: noVNC (端口 6080) 和 VNC (端口 5901) 提供了对桌面环境的直接访问。**优先级：高**。

- [ ] **CODE-REVIEW-ITEM-004: Chrome调试端口 (9222) 的暴露风险与相关代码**
    *   **目标代码/配置区域**:
        *   `docker-compose.yml` 和 `Dockerfile` 中关于端口 9222 的暴露配置。
        *   应用中任何与浏览器实例交互的代码，特别是通过CDP（Chrome DevTools Protocol）进行通信的模块 (可能在 `src/browser/` 或 `src/agent/` 目录下)。
        *   环境变量如 `BROWSER_DEBUGGING_HOST`, `BROWSER_DEBUGGING_PORT`, `BROWSER_CDP` 的使用。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **被动缺失**: Chrome调试端口不应直接对公网暴露。虽然部署报告认为是“内部访问”，但docker-compose映射到了0.0.0.0，需要确认是否有网络层防火墙。代码层面需要考虑如果此端口可被非预期访问的后果。
        2.  **主动缺陷**: 如果应用代码通过CDP执行的操作本身存在漏洞（例如，处理来自不可信源的指令去操作浏览器），可能导致浏览器被滥用。
    *   **建议的白盒代码审计方法/关注点**:
        1.  虽然端口暴露是配置问题，但代码层面需检查：是否有代码依赖此端口必须从容器外部访问？
        2.  审查所有使用CDP与浏览器交互的代码，确保其不会执行来自不可信源的任意指令。
        3.  确认 `BROWSER_DEBUGGING_HOST` 是否总是配置为 `localhost` 或安全的内部地址。
    *   **部署上下文与优先级**: Chrome调试端口提供了对浏览器内部的完全控制，若被滥用风险极大。**优先级：中** (因为其主要风险在于网络配置，但代码层面也需配合审查)。

- [ ] **CODE-REVIEW-ITEM-005: 多进程管理与通信安全 (Supervisor及各进程)**
    *   **目标代码/配置区域**:
        *   `supervisord.conf` 中各进程的启动参数、环境变量传递。
        *   涉及进程间通信的代码，例如 `novnc` 代理到 `x11vnc` (localhost:5901)。
        *   主Web UI应用 (`webui.py`) 与浏览器控制进程或VNC环境的潜在交互逻辑。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **被动缺失**: 进程以过高权限运行（Dockerfile中 `cap_add: SYS_ADMIN` 已是已知风险点，代码层面看是否有不必要的权限使用）。
        2.  **主动缺陷**: 如果进程间通信（如本地socket、管道）未做认证或输入验证，可能导致权限提升或服务被干扰。
        3.  **被动缺失**: 敏感信息（如API密钥、密码）通过环境变量传递给进程时，需确保进程本身是受保护的。
    *   **建议的白盒代码审计方法/关注点**:
        1.  逐一审查 `supervisord.conf` 中每个进程的启动命令，寻找是否有可被利用的参数或不安全配置。
        2.  特别关注 `novnc` -> `x11vnc` 的连接，虽然是本地，但要确保 `x11vnc` 的 `-rfbauth` 机制是可靠的。
        3.  分析 `webui.py` 是否有任何直接调用或影响其他受控进程（如xvfb, x11vnc, novnc, chrome）的危险方式。
    *   **部署上下文与优先级**: Supervisord管理着所有核心服务。**优先级：中**。

- [ ] **CODE-REVIEW-ITEM-006: 外部服务依赖与API密钥管理**
    *   **目标代码/配置区域**:
        *   所有与外部LLM API（OpenAI, Anthropic, DeepSeek等）交互的代码模块 (可能在 `src/agent/` 或 `src/llm_providers/` 等)。
        *   环境变量（`.env.example` 中定义的 `*_API_KEY`, `*_ENDPOINT`）的加载和使用方式 (`webui.py` 或配置文件加载模块)。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **主动缺陷/被动缺失**: API密钥硬编码在代码中（而非通过环境变量）。
        2.  **主动缺陷**: SSRF风险，如果API端点 (`*_ENDPOINT`) 可以被用户部分或完全控制。
        3.  **被动缺失**: 日志中意外泄露API密钥或敏感请求/响应数据。
    *   **建议的白盒代码审计方法/关注点**:
        1.  确认所有API密钥都通过环境变量加载，代码中无硬编码。
        2.  检查所有外部API请求的构建，特别是URL和请求体的构造，确保用户输入不能操纵请求目标或核心参数。
        3.  审查日志记录逻辑，确保不会记录完整的API密钥或高度敏感的交互内容。
    *   **部署上下文与优先级**: LLM API是核心功能，密钥泄露或API滥用会导致严重问题。**优先级：高**。

- [ ] **CODE-REVIEW-ITEM-007: 文件系统操作与路径安全**
    *   **目标代码/配置区域**:
        *   所有执行文件读写操作的代码，例如浏览器用户数据持久化 (环境变量 `BROWSER_USER_DATA`) 相关逻辑、配置文件读写等。
        *   `Dockerfile` 和 `docker-compose.yml` 中卷映射和文件权限的设置。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **主动缺陷**: 路径遍历，如果用户输入被用于构造文件路径而未被正确净化。
        2.  **被动缺失**: 容器内文件权限配置不当，可能允许应用进程非预期地读写敏感文件。
        3.  **主动缺陷**: 不安全的文件上传/下载功能（如果存在）。
    *   **建议的白盒代码审计方法/关注点**:
        1.  搜索代码中所有 `open()`, `os.path`, `shutil` 等文件操作相关的函数。
        2.  追踪所有用于构造文件路径的变量来源，特别是那些可能受用户影响的。
        3.  检查 `BROWSER_USER_DATA` 等路径配置是否可能被滥用以访问非预期目录。
    *   **部署上下文与优先级**: 文件系统操作不当可能导致信息泄露或数据篡改。**优先级：中**。

- [ ] **CODE-REVIEW-ITEM-008: 依赖库版本与已知漏洞 (Python `requirements.txt`)**
    *   **目标代码/配置区域**:
        *   `requirements.txt` 文件。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **被动缺失**: 使用了存在已知公开漏洞 (CVEs) 的老旧第三方库版本。
    *   **建议的白盒代码审计方法/关注点**:
        1.  将 `requirements.txt` 中的库及其版本与NVD、Snyk、pip-audit等漏洞数据库进行比对。
        2.  特别关注核心依赖如 `Gradio`, `browser-use`, 以及其他网络、解析相关的库。
        3.  评估已知漏洞对本项目的实际可利用性和影响。
    *   **部署上下文与优先级**: 第三方库漏洞是常见的攻击向量。**优先级：中**。