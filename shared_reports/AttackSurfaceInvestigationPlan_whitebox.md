# 攻击面调查计划 (白盒代码审计导向) - JStachio 项目

## 引言/概述

本攻击面调查计划基于《JStachio 项目部署架构分析报告》的关键发现、项目本身的技术栈（Java 17, Maven, Spring Boot）、用户进行软件项目安全审计的初始需求，以及对项目类型的综合判断。

JStachio 项目的核心是一个Java Mustache模板引擎及其相关的编译时注解处理器。它旨在将模板编译为Java源代码，实现类型安全和高性能渲染。此外，项目还包含与Spring框架（WebMVC, WebFlux）集成的可选模块及示例应用。

**项目类型判断**:
*   **核心库和编译器模块 (jstachio API, compiler, jstachio-prisms)**: 属于**底层基础组件/库**。审计重点是**主动缺陷**，特别是与模板解析、代码生成、输入处理相关的漏洞。
*   **Spring 集成模块和示例应用 (jstachio-spring-*, jstachio-spring-example-*, etc.)**: 属于**应用层项目**。审计将**同等关注主动缺陷和被动缺失/选择**，包括Web应用常见漏洞、安全配置、依赖管理等。

**审计策略**:
*   对于核心库，将优先深度挖掘可能导致严重安全漏洞（如远程代码执行、模板注入、信息泄露）的**主动缺陷**。
*   对于Spring集成和示例应用，将同时审查**主动缺陷**（如XSS, CSRF, SQL注入 - 如果适用的话）和**被动缺失/选择**（如安全配置错误、不安全的默认设置）。

**计划检查项数量评估**: 基于项目的模块化特性和潜在风险点，初步计划包含约 10-12 个核心检查项，覆盖模板处理、代码生成、Spring集成、输入验证、依赖管理等关键领域。

---

## 详细检查项

### A. 核心模板引擎与编译器 (JStachio API & Compiler Modules)

- [ ] **CODE-REVIEW-ITEM-001: 模板解析与编译过程中的潜在模板注入风险 (主动缺陷)**
    *   **目标代码/配置区域**:
        *   `io.jstach.apt` 包下的注解处理器相关类，特别是处理模板文件内容、解析模板结构、以及生成Java源代码的逻辑。
        *   `io.jstach.jstachio` 核心API中与模板加载、缓存、渲染相关的类。
        *   所有直接或间接处理用户定义模板字符串或从文件系统读取模板内容的逻辑。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **主动缺陷**: 模板注入（如果模板内容或传递给模板的数据模型中包含恶意构造的Mustache指令或特殊字符，可能导致非预期的代码执行路径或敏感信息泄露）。
        2.  **主动缺陷**: 在代码生成阶段，如果模板内容未被正确转义或处理，生成的Java代码可能包含可利用的漏洞。
        3.  **主动缺陷**: 资源注入（例如，如果模板名或路径可被外部控制，可能导致加载非预期的模板文件）。
    *   **建议的白盒代码审计方法/关注点**:
        1.  详细跟踪模板内容从输入（文件、字符串）到编译（注解处理）、再到生成Java代码的完整流程。
        2.  审查用于解析Mustache标签、变量、区块的逻辑，识别是否存在未正确处理或转义的特殊序列。
        3.  分析生成的Java代码结构，确保用户提供的数据在渲染时被安全地处理，特别是对于HTML/XML/JS上下文中的输出，是否进行了恰当的上下文编码。
        4.  检查模板加载机制，确认路径处理是否安全，防止路径遍历或任意文件读取。
    *   **部署上下文与优先级**: 核心功能，影响所有使用JStachio的项目。优先级：极高。

- [ ] **CODE-REVIEW-ITEM-002: 注解处理器(APT)的安全性审计 (主动缺陷)**
    *   **目标代码/配置区域**:
        *   `io.jstach.apt` 包及其子包下的所有注解处理器实现。
        *   `io.jstach.jstachio.spi.JStachioFilter` 和相关服务提供者接口的实现，及其在APT中的应用。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **主动缺陷**: 在处理注解参数或扫描类路径元素时，是否存在路径遍历、XML外部实体注入（XXE，如果处理器读取外部XML配置/元数据）、或反序列化漏洞。
        2.  **主动缺陷**: 生成的代码的安全性，例如，生成的代码是否可能引入新的漏洞，或者是否会不安全地处理输入。
        3.  **主动缺陷**: 错误处理机制是否可能泄露过多编译时环境信息。
    *   **建议的白盒代码审计方法/关注点**:
        1.  审查处理器如何获取和处理来自被注解元素或外部文件的输入（例如 `pom.xml` 中的配置传递给APT）。
        2.  如果处理器涉及文件I/O（读写临时文件、配置文件等），严格检查路径构造和文件操作的安全性。
        3.  分析代码生成逻辑，确保其遵循安全编码实践，特别是对于动态生成的方法体或字符串常量。
        4.  检查 `JStachioFilter` 等扩展点实现，确保它们不会引入安全风险。
    *   **部署上下文与优先级**: 编译时组件，影响开发安全和生成代码的质量。优先级：高。

- [ ] **CODE-REVIEW-ITEM-003: 核心API的输入验证和边界条件 (主动缺陷)**
    *   **目标代码/配置区域**:
        *   `io.jstach.jstachio.JStachio` 接口及其实现类。
        *   `io.jstach.jstachio.Template` 接口及其实现类。
        *   所有接受外部数据作为模型对象进行渲染的公开API方法。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **主动缺陷**: 对传入的数据模型（POJOs, Maps等）的字段进行渲染时，是否存在因类型处理不当、null值处理不当或递归结构处理不当导致的运行时异常、无限循环或信息泄露。
        2.  **主动缺陷**: 数字、日期等类型的格式化是否存在区域设置（Locale）相关漏洞或格式化字符串注入。
        3.  **主动缺陷**: 边界条件处理，例如超大集合、超长字符串作为模型数据传入。
    *   **建议的白盒代码审计方法/关注点**:
        1.  审查数据模型对象在传递给渲染器之前和过程中的处理逻辑。
        2.  检查所有内建的格式化器或自定义格式化器的实现，确保它们对输入进行充分验证。
        3.  关注迭代（loops）和条件渲染（conditional blocks）逻辑，检查是否存在因数据模型特定状态导致的意外行为。
    *   **部署上下文与优先级**: 核心运行时API，直接影响应用的健壮性和安全性。优先级：高。

- [ ] **CODE-REVIEW-ITEM-004: JMustache后备渲染器的安全使用 (主动缺陷 / 被动缺失)**
    *   **目标代码/配置区域**:
        *   `io.jstach.opt.jmustache` 模块。
        *   `jstachio.jmustache.disable` 配置项的使用逻辑。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **主动缺陷 (源于JMustache)**: JMustache库本身可能存在的已知或未知漏洞（如模板注入）。需依赖对JMustache库的审计或安全评估。
        2.  **被动缺失**: 如果JMustache后备渲染器在特定场景下（例如开发环境）默认启用，且其安全特性弱于JStachio自身生成的代码，可能构成风险。
    *   **建议的白盒代码审计方法/关注点**:
        1.  审查JStachio与JMustache库的集成代码，理解数据如何传递和控制流如何转换。
        2.  确认 `jstachio.jmustache.disable` 配置项的默认值及在不同环境（如生产与开发）的行为是否符合安全预期。
        3.  研究JMustache库（版本1.15）的公开漏洞报告。
    *   **部署上下文与优先级**: 可选模块，但在特定配置下可能启用。优先级：中（取决于JMustache的安全性）。

- [ ] **CODE-REVIEW-ITEM-005: 资源和服务加载机制 (主动缺陷)**
    *   **目标代码/配置区域**:
        *   使用 `java.util.ServiceLoader` 加载 `io.jstach.jstachio.spi.JStachioExtension` 或其他SPI的逻辑。
        *   任何通过类名动态加载类或资源的代码。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **主动缺陷**: 如果类名或资源名可以被外部影响，可能导致加载恶意类或资源，引发代码执行或信息泄露。
    *   **建议的白盒代码审计方法/关注点**:
        1.  识别所有使用 `ServiceLoader` 或反射进行类/资源加载的地方。
        2.  分析这些加载点所依赖的输入源是否可信。
        3.  确保对加载的服务或扩展进行了适当的验证（如果可能）。
    *   **部署上下文与优先级**: 核心扩展机制，影响系统的可扩展性和安全性。优先级：中。

### B. Spring 集成模块 (jstachio-spring-\*)

- [ ] **CODE-REVIEW-ITEM-006: Spring ViewResolver 和视图渲染过程中的XSS风险 (主动缺陷)**
    *   **目标代码/配置区域**:
        *   `io.jstach.opt.spring.webmvc.JStachioViewResolver`
        *   `io.jstach.opt.spring.webflux.JStachioViewResolver`
        *   `io.jstach.opt.spring.JStachioHttpMessageConverter`
        *   相关的视图渲染逻辑，特别是数据模型到模板的绑定和输出。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **主动缺陷**: 跨站脚本 (XSS)。如果从Controller传递到视图的数据未经JStachio模板引擎正确转义（或模板本身未设计为安全输出），并且最终在HTTP响应中呈现。
    *   **建议的白盒代码审计方法/关注点**:
        1.  审查ViewResolver如何获取和处理模型数据。
        2.  确认JStachio在Spring集成中，对于HTML/JS等上下文的默认转义行为是否开启且有效。
        3.  追踪用户可控数据从Controller参数/请求体到模型，再到模板渲染输出到HTTP响应的完整路径。
        4.  特别关注 `@JStache(contentType=...)` 注解，验证不同内容类型（HTML, JS, XML, PlainText）的输出编码是否正确。
    *   **部署上下文与优先级**: Spring Web集成核心，直接影响Web应用的安全性。优先级：极高。

- [ ] **CODE-REVIEW-ITEM-007: Spring Security 集成和默认安全配置 (被动缺失/选择)**
    *   **目标代码/配置区域**:
        *   虽然JStachio本身不直接提供Security功能，但示例应用 (`jstachio-spring-example`, `jstachio-spring-webflux-example`) 可能依赖Spring Boot的自动安全配置。
        *   检查是否存在自定义的 `WebSecurityConfigurerAdapter` 或 `SecurityFilterChain` Bean。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **被动缺失**: Spring Boot Actuator端点是否默认暴露过多敏感信息，且未受保护。
        2.  **被动缺失**: CSRF保护是否对所有相关端点启用了（对于WebMVC同步请求）。
        3.  **被动缺失**: 依赖的Spring Security版本是否存在已知漏洞。
        4.  **被动缺失**: 示例应用中是否存在硬编码的凭证或弱默认配置。
    *   **建议的白盒代码审计方法/关注点**:
        1.  审计示例应用的 `application.properties` 或 `application.yml` 文件中与安全相关的配置（如 `management.endpoints.web.exposure.include`）。
        2.  检查 `pom.xml` 中 `spring-boot-starter-security` 的版本。
        3.  如果存在自定义安全配置类，审查其配置是否符合Spring Security最佳实践。
        4.  搜索代码中是否存在硬编码的密码、密钥等。
    *   **部署上下文与优先级**: 影响示例应用的安全，并可能作为用户集成JStachio到Spring应用时的参考。优先级：高。

- [ ] **CODE-REVIEW-ITEM-008: Spring 示例应用的输入验证和业务逻辑漏洞 (主动缺陷)**
    *   **目标代码/配置区域**:
        *   `io.jstach.opt.spring.example.App` 及其相关的Controller, Service类。
        *   `io.jstach.opt.spring.webflux.example.App` 及其相关的Handler, Service类。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **主动缺陷**: 常见的Web应用漏洞，如：
            *   未验证的重定向和转发。
            *   如果示例应用涉及文件上传/下载，则检查路径遍历、任意文件操作。
            *   （如果未来添加）SQL注入、命令注入等（目前部署报告未提及数据库）。
        2.  **主动缺陷**: 业务逻辑漏洞，例如，在示例应用的功能中是否存在可被滥用的逻辑缺陷。
    *   **建议的白盒代码审计方法/关注点**:
        1.  审查所有处理用户输入的Controller方法/Handler函数，检查输入是否经过充分验证（类型、长度、格式、范围）。
        2.  分析示例应用的具体功能（根据示例代码确定），思考是否存在绕过预期流程或权限检查的可能。
        3.  注意任何与外部服务交互的代码（目前未发现，但需留意）。
    *   **部署上下文与优先级**: 示例应用，虽然不直接是库的核心，但其安全性会影响用户对库的信任和集成实践。优先级：中。

### C. 通用安全考虑

- [ ] **CODE-REVIEW-ITEM-009: 依赖库版本和已知漏洞 (被动缺失/选择)**
    *   **目标代码/配置区域**:
        *   项目根 `pom.xml` 以及各子模块的 `pom.xml` 文件。
        *   特别是核心依赖如 JMustache, Spring Framework, Spring Boot, Jackson。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **被动缺失**: 使用了存在已知CVE的第三方库版本。
    *   **建议的白盒代码审计方法/关注点**:
        1.  提取主要依赖及其版本号。
        2.  使用NVD/CVE数据库或自动化工具（如OWASP Dependency-Check，IDE插件）扫描已知漏洞。
        3.  关注未被 `dependabot.yml` 覆盖的依赖，或 `dependabot.yml` 配置是否及时更新。
    *   **部署上下文与优先级**: 影响整个项目的安全性。优先级：高。

- [ ] **CODE-REVIEW-ITEM-010: 日志记录和错误处理 (主动缺陷/被动缺失)**
    *   **目标代码/配置区域**:
        *   项目中所有使用日志框架（如SLF4J）的地方。
        *   `try-catch` 块和异常处理逻辑。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **主动缺陷**: 日志注入（如果用户可控数据未经过滤直接写入日志）。
        2.  **被动缺失**: 错误信息泄露（异常堆栈、敏感配置、内部状态等通过日志或错误响应暴露给用户）。
        3.  **被动缺失**: 日志级别配置不当，可能导致生产环境日志过多或过少，影响问题排查和安全事件响应。
    *   **建议的白盒代码审计方法/关注点**:
        1.  审查日志记录点，确保用户输入在记录前进行了适当的清理（例如，替换CRLF字符）。
        2.  分析异常处理路径，确保不会将敏感的异常详情直接暴露给客户端或不安全的日志目标。
        3.  检查示例应用中的日志配置文件（如`logback.xml`, `log4j2.xml` - 如果存在）。
    *   **部署上下文与优先级**: 通用安全实践，影响可维护性和安全性。优先级：中。

- [ ] **CODE-REVIEW-ITEM-011: 文件系统操作的安全性 (主动缺陷)**
    *   **目标代码/配置区域**:
        *   所有涉及读取、写入、创建、删除文件或目录的代码。特别是在注解处理器 (`io.jstach.apt`) 和模板加载逻辑 (`io.jstach.jstachio`) 中。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **主动缺陷**: 路径遍历（如果文件名或路径部分可被外部输入控制）。
        2.  **主动缺陷**: 任意文件写入/创建/删除。
        3.  **主动缺陷**: 竞争条件（TOCTOU）如果文件操作不是原子性的。
    *   **建议的白盒代码审计方法/关注点**:
        1.  识别所有使用 `java.io.File`, `java.nio.file.Path` 等API的地方。
        2.  分析文件路径的来源，确定是否受外部输入影响。
        3.  如果路径可被影响，检查是否进行了严格的规范化和验证，以防止 `../` 等序列。
        4.  检查文件权限设置是否恰当。
    *   **部署上下文与优先级**: 影响编译时安全和运行时模板加载。优先级：高。

- [ ] **CODE-REVIEW-ITEM-012: XML 处理安全性 (若适用) (主动缺陷)**
    *   **目标代码/配置区域**:
        *   检查项目（特别是APT模块或构建脚本）中是否有直接使用SAX, DOM, StAX等XML解析器的代码，或间接通过库使用。
        *   部署报告中未明确指出，但需警惕。
    *   **要审计的潜在风险/漏洞类型**:
        1.  **主动缺陷**: XML外部实体注入 (XXE)。
        2.  **主动缺陷**: XML实体扩展攻击 (Billion Laughs Attack)。
    *   **建议的白盒代码审计方法/关注点**:
        1.  搜索代码中是否存在 `javax.xml.parsers` 或类似库的使用。
        2.  如果发现XML解析，检查是否禁用了外部实体加载 (e.g., `FEATURE_SECURE_PROCESSING`, `setExpandEntityReferences(false)`等)。
    *   **部署上下文与优先级**: 条件性检查，如果项目确实处理了外部XML，则优先级为高。

---