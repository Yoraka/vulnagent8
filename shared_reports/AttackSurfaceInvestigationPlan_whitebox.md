# 攻击面调查计划 - 白盒代码审计

## 引言/概述
本攻击面调查计划旨在指导对 `/data/mall_code` 项目进行白盒代码审计。计划基于《部署架构报告》和项目 `pom.xml` 文件分析，重点关注Spring Boot微服务架构下的常见应用安全风险。审计将优先关注认证授权、数据输入处理、敏感数据管理、API接口安全以及第三方依赖等易受攻击的区域。由于部署架构报告中未明确指出外部可达性，本次计划将假设所有服务在内部网络中通过默认端口（8080, 8081, 8082）监听，并且重点审查暴露HTTP接口的服务。

## 详细检查项

- [x] CODE-REVIEW-ITEM-001: 用户认证与JWT令牌处理安全审计
    *   **目标代码/配置区域**:
        *   `mall-security` 模块中与用户认证、JWT生成/验证相关的代码（例如：`com.macro.mall.security.component.JwtAuthenticationTokenFilter.java`, `com.macro.mall.security.util.JwtTokenUtil.java`）。
        *   `mall-admin` 和 `mall-portal` 中处理用户登录、注册、修改密码的Controller和Service层代码（例如：`com.macro.mall.admin.controller.UmsAdminController.java`, `com.macro.mall.portal.controller.MemberController.java` 及其对应的Service实现）。
        *   所有引用 `jjwt` 库的地方。
        *   `application.yml` 中与JWT密钥、过期时间相关的配置。
    *   **要审计的潜在风险/漏洞类型**:
        1.  认证绕过（弱密码策略、未加盐哈希存储密码）。
        2.  JWT令牌伪造、篡改、会话固定、重放攻击。
        3.  用户枚举（登录错误信息不当）。
        4.  敏感信息泄露（例如，JWT中包含的敏感信息）。
    *   **建议的白盒代码审计方法/关注点**:
        1.  检查密码存储是否使用BCrypt等强哈希算法，并确保加盐。
        2.  审查JWT令牌的签名、验证逻辑，确认签名算法强度、密钥管理、claims的验证。
        3.  检查是否正确处理JWT过期、撤销和黑名单机制。
        4.  确认登录、注册接口的错误提示是否模糊，避免泄露用户信息。
        5.  检查用户会话有效期和刷新机制。
    *   **部署上下文与优先级**: 认证模块是系统的核心安全入口，影响内外部所有用户。优先级：极高。

- [x] CODE-REVIEW-ITEM-002: 访问控制与授权机制审计 (RBAC/权限验证)
    *   **目标代码/配置区域**:
        *   `mall-security` 模块中与权限相关的配置类和实现（例如：`com.macro.mall.security.config.SecurityConfig.java`, `com.macro.mall.security.component.DynamicSecurityFilter.java`）。
        *   `mall-admin` 模块中所有标注有 `@PreAuthorize` 或通过API进行权限验证的Controller和Service方法。
        *   与用户角色、权限数据模型和加载相关的代码。
    *   **要审计的潜在风险/漏洞类型**:
        1.  垂直越权 (Vertical Privilege Escalation)。
        2.  水平越权 (Horizontal Privilege Escalation - BOLA/IDOR)。
        3.  功能级访问控制绕过 (Broken Function Level Access Control)。
        4.  授权逻辑缺陷 (e.g., 默认允许访问)。
    *   **建议的白盒代码审计方法/关注点**:
        1.  审查 `SecurityConfig` 中定义的URL拦截规则和权限分配策略。
        2.  确认敏感操作（如用户管理、订单修改、商品上下架）是否有严格的权限检查，并检查是否可绕过。
        3.  对于涉及用户ID或资源ID的操作，检查是否进行IDOR验证，确保用户只能访问自己的数据或被授权的数据。
        4.  分析自定义权限拦截器的实现逻辑，确保其可靠性。
    *   **部署上下文与优先级**: 影响整个系统的安全边界和数据隔离。优先级：极高。

- [x] CODE-REVIEW-ITEM-003: 输入验证与数据处理审计 (SQL注入、XSS、命令注入等)
    *   **目标代码/配置区域**:
        *   所有Controller层方法，特别是接收用户输入参数的方法（例如：`@RequestParam`, `@RequestBody`, `@PathVariable`）。
        *   Service层和DAO层中直接或间接处理用户输入数据的方法。
        *   所有使用MyBatis进行数据库操作的Mapper XML文件和Java接口。
        *   `mall-search` 服务中处理搜索参数的代码。
    *   **要审计的潜在风险/漏洞类型**:
        1.  SQL注入 (MyBatis动态SQL拼接不当)。
        2.  跨站脚本 (XSS) (未正确编码/转义用户输出)。
        3.  命令注入 (如果存在外部命令执行)。
        4.  不安全的反序列化 (如果使用了Java原生或不安全的反序列化机制)。
        5.  XXE (XML External Entities) (如果处理XML输入)。
    *   **建议的白盒代码审计方法/关注点**:
        1.  检查所有MyBatis查询，确保使用 `#{} `而非 `${}` 来处理用户输入，或者使用预编译语句/ORM框架的参数化查询功能。
        2.  追踪用户输入从接收到输出到前端的路径，确保所有用户生成内容在显示前都经过适当的HTML实体编码或净化。
        3.  审查文件上传功能，检查文件类型、大小、内容、文件名的验证逻辑，以及存储路径是否安全。
        4.  检查对第三方库或系统调用的输入是否经过严格验证。
        5.  `mall-search` 服务中，若使用Elasticsearch，检查是否存在Elasticsearch查询注入风险。
    *   **部署上下文与优先级**: 广泛存在于各个服务与用户交互的接口，是最常见的漏洞类型。优先级：高。

- [ ] CODE-REVIEW-ITEM-004: 敏感信息存储与硬编码审计
    *   **目标代码/配置区域**:
        *   所有 `application.yml` 文件中配置的数据库凭证、Redis密码、OSS密钥、JWT密钥。
        *   代码中可能硬编码敏感信息的常量或变量。
        *   日志输出中是否包含敏感信息。
    *   **要审计的潜在风险/漏洞类型**:
        1.  敏感信息硬编码或弱加密存储。
        2.  日志中泄露敏感信息。
    *   **建议的白盒代码审计方法/关注点**:
        1.  检查配置文件中是否包含明文的数据库密码、API密钥等，并建议使用环境变量或加密配置。
        2.  全局搜索代码中的 `password`, `secret`, `key` 等关键词，检查是否存在硬编码。
        3.  审查日志输出，确保不记录用户密码、会话ID等敏感信息。
    *   **部署上下文与优先级**: 直接影响系统的机密性。优先级：高。

- [ ] CODE-REVIEW-ITEM-005: 业务逻辑漏洞审计 (订单、商品、用户管理)
    *   **目标代码/配置区域**:
        *   `mall-admin` 和 `mall-portal` 中涉及核心业务逻辑（如订单创建/修改/支付、商品管理、购物车、优惠券计算）的Service层代码。
        *   与金融交易或高价值数据相关的逻辑。
    *   **要审计的潜在风险/漏洞类型**:
        1.  金额篡改、越权下单、库存绕过。
        2.  逻辑炸弹、循环（如优惠券无限领取）。
        3.  不完整的业务流程导致的安全问题。
    *   **建议的白盒代码审计方法/关注点**:
        1.  模拟业务流程中的每一步，检查所有状态转换是否安全。
        2.  审查价格、库存、优惠券等计算逻辑，确认是否在服务器端进行强制验证。
        3.  检查是否存在竞态条件漏洞。
        4.  确认所有的业务操作都附加了授权检查。
    *   **部署上下文与优先级**: 直接影响业务的正确性和平台的经济利益。优先级：高。

- [ ] CODE-REVIEW-ITEM-006: 日志记录与监控审计
    *   **目标代码/配置区域**:
        *   `logstash-logback-encoder` 相关配置（例如：`logstash.conf` 和 Spring Boot日志配置）。
        *   所有服务中的日志记录点。
    *   **要审计的潜在风险/漏洞类型**:
        1.  日志伪造。
        2.  日志中包含敏感信息。
        3.  审计日志不充分。
    *   **建议的白盒代码审计方法/关注点**:
        1.  确保日志中不记录用户密码、会话ID等敏感信息。
        2.  检查是否对关键安全事件（如登录失败、认证失败、权限拒绝）进行了充分的记录。
        3.  审查日志输出格式，确保不会被注入恶意内容导致日志伪造。
    *   **部署上下文与优先级**: 影响安全事件响应和追踪。优先级：中。

- [ ] CODE-REVIEW-ITEM-007: 第三方依赖安全审计
    *   **目标代码/配置区域**:
        *   `pom.xml` 中所有引入的第三方依赖。
    *   **要审计的潜在风险/漏洞类型**:
        1.  已知漏洞的第三方组件 (组件漏洞)。
        2.  不安全的依赖配置。
    *   **建议的白盒代码审计方法/关注点**:
        1.  列出所有直接和间接依赖及其版本。
        2.  使用SCA (Software Composition Analysis)工具（如果可用）或手动交叉检查CVE数据库，查找已知漏洞。
        3.  检查依赖的使用方式，确认是否有不当的配置。
    *   **部署上下文与优先级**: 影响整个应用的安全基线。优先级：高。

- [ ] CODE-REVIEW-ITEM-008: 文件上传与下载安全审计
    *   **目标代码/配置区域**:
        *   与 `aliyun-oss` 或 `minio` 相关的上传/下载逻辑（例如：涉及到文件上传的Controller和Service方法）。
    *   **要审计的潜在风险/漏洞类型**:
        1.  任意文件上传（WebShell）。
        2.  文件包含、遍历。
        3.  文件名欺骗。
        4.  存储桶配置不安全。
    *   **建议的白盒代码审计方法/关注点**:
        1.  检查文件上传的类型（MIME类型）、大小、数量是否做了严格验证。
        2.  确认文件存储路径是否在应用服务器的WEB容器之外，且无法直接执行。
        3.  审查文件名生成逻辑，避免使用用户提供文件名或避免路径遍历字符。
        4.  检查OSS/MinIO的访问权限配置，确保最小权限原则。
    *   **部署上下文与优先级**: mall项目可能涉及图片、附件上传，风险较高。优先级：高。

- [ ] CODE-REVIEW-ITEM-009: API接口安全审计 (Swagger文档与未授权访问)
    *   **目标代码/配置区域**:
        *   所有Controller接口，尤其是在 `mall-admin` 和 `mall-portal` 中。
        *   `springfox-swagger` 的配置。
    *   **要审计的潜在风险/漏洞类型**:
        1.  未经授权访问API接口。
        2.  API接口过度暴露敏感信息。
        3.  Swagger UI本身或其配置暴露。
    *   **建议的白盒代码审计方法/关注点**:
        1.  确认所有API接口是否都有明确的认证和授权控制，特别是那些默认公共或开发阶段暴露的接口。
        2.  检查Swagger UI在生产环境中是否被禁用或受限访问。
        3.  审查API响应中是否包含不必要的敏感数据。
    *   **部署上下文与优先级**: 如果Swagger暴露在公网，可能导致API接口信息泄露。优先级：中。

- [ ] CODE-REVIEW-ITEM-010: 跨服务通信安全审计
    *   **目标代码/配置区域**:
        *   `mall-demo` 中调用 `mall-admin` (例如：`http://localhost:8080`) 的代码。
        *   所有服务之间通过HTTP、Redis、RabbitMQ进行的内部通信。
    *   **要审计的潜在风险/漏洞类型**:
        1.  内部API未授权访问。
        2.  服务间通信缺乏认证或加密。
        3.  DDoS攻击或资源耗尽。
    *   **建议的白盒代码审计方法/关注点**:
        1.  审查服务间调用是否包含认证机制（如内部API Key/Token）。
        2.  确认内部网络通信是否使用加密通道（如HTTPS），尤其在敏感数据传输时。
        3.  检查RestTemplate或FeignClient等客户端配置，确保超时和重试机制合理，防止内部服务间DDoS。
    *   **部署上下文与优先级**: 内部服务间的信任往往被滥用，但实际环境中可能脆弱。优先级：中。

- [ ] CODE-REVIEW-ITEM-011: 错误处理与信息泄露审计
    *   **目标代码/配置区域**:
        *   全局异常处理 (`@ControllerAdvice`)。
        *   所有Controller和Service层中可能抛出异常的地方。
    *   **要审计的潜在风险/漏洞类型**:
        1.  详细错误信息泄露（堆栈跟踪、敏感业务数据）。
        2.  日志中包含敏感信息。
    *   **建议的白盒代码审计方法/关注点**:
        1.  确认生产环境下是否禁用详细的堆栈跟踪和错误信息显示给用户。
        2.  审查自定义错误页面和错误响应，确保不泄露过多系统信息。
        3.  检查异常捕获和处理逻辑，防止未捕获异常导致的应用崩溃或信息泄露。
    *   **部署上下文与优先级**: 直接影响信息泄露。优先级：中。

- [ ] CODE-REVIEW-ITEM-012: 数据库操作审计 (MyBatis层)
    *   **目标代码/配置区域**:
        *   `mall-mbg` 模块生成的MyBatis Mapper接口和XML文件。
        *   所有涉及数据库查询、插入、更新、删除的方法。
    *   **要审计的潜在风险/漏洞类型**:
        1.  SQL注入 (如果使用了 `${}` 而非 `#{} `)。
        2.  批量操作未验证。
        3.  数据泄露 (未限制查询字段)。
    *   **建议的白盒代码审计方法/关注点**:
        1.  确认所有的动态SQL都正确使用了预编译语句 `#{} `。
        2.  检查批量更新/删除操作是否有足够的验证和权限控制，防止防误操作或恶意删除。
        3.  对于涉及敏感数据的查询，审查是否只返回必要字段，避免不必要的数据传输和泄露。
    *   **部署上下文与优先级**: 数据库是核心数据所在，数据安全是重中之重。优先级：高。

- [ ] CODE-REVIEW-ITEM-013: 配置安全审计 (Spring Boot `application.yml` 配置)
    *   **目标代码/配置区域**:
        *   所有 `application.yml` 文件。
    *   **要审计的潜在风险/漏洞类型**:
        1.  默认或不安全配置（如调试模式开启、不安全的Actuator端点）。
        2.  缓存不安全配置。
        3.  不安全的 CORS 配置。
    *   **建议的白盒代码审计方法/关注点**:
        1.  检查Spring Boot Actuator端点是否暴露过多（如 `/actuator/*`），或配置了不安全的访问策略。
        2.  审查Session配置和Redis缓存配置，确保安全性（例如避免弱键）。
        3.  检查CORS（跨域资源共享）配置是否限制在信任域内，避免宽泛的 `allow-origins`。
        4.  确保生产环境和开发环境的配置分离。
    *   **部署上下文与优先级**: 配置错误可能导致各种安全漏洞。优先级：中。

- [ ] CODE-REVIEW-ITEM-014: 定时任务安全审计
    *   **目标代码/配置区域**:
        *   所有使用 `@Scheduled` 注解的定时任务方法。
    *   **要审计的潜在风险/漏洞类型**:
        1.  敏感操作未授权。
        2.  资源耗尽。
        3.  竞态条件。
    *   **建议的白盒代码审计方法/关注点**:
        1.  检查定时任务是否执行敏感操作，并确认这些操作是否只在特定环境下或通过安全方式触发。
        2.  确保定时任务的执行不会导致资源过度消耗或死锁。
        3.  如果定时任务处理数据，要确保其处理逻辑的正确性与安全性。
    *   **部署上下文与优先级**: 定时任务通常在后台运行，易被忽视。优先级：低。

- [ ] CODE-REVIEW-ITEM-015: 内存马排查 (如果存在部署热更新或动态代码加载)
    *   **目标代码/配置区域**:
        *   所有可能进行动态代码加载、反射操作或自定义类加载器的代码。
    *   **要审计的潜在风险/漏洞类型**:
        1.  JSP/Servlet内存马。
        2.  Webshell注入。
    *   **建议的白盒代码审计方法/关注点**:
        1.  检查是否存在不安全的反射调用 `forName().newInstance()` 或动态代码加载。
        2.  审查任何可能接收外部参数并用于类名或方法名反射的代码。
        3.  如果项目存在代码热更新机制，需特别关注其安全性。
    *   **部署上下文与优先级**: 特殊且隐蔽的攻击方式，通常需要特定条件。优先级：低-中。