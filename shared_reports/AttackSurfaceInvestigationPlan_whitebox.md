# 攻击面调查计划：One-API 项目

## 引言/概述

本计划基于《部署架构报告》分析结果制定，针对 one-api 项目（Spring Boot API 管理平台）进行白盒代码审计。项目采用 Spring Boot 2.7.5 框架，使用 JWT 认证，依赖 MySQL 和 Redis，通过 Nginx 反向代理暴露服务。审计将重点关注主动缺陷（代码逻辑漏洞）和被动缺失（配置安全问题），特别关注身份认证、API 端点安全、数据库连接配置等高风险区域。计划包含 10 项核心检查项，覆盖应用关键攻击面。

**重要声明**：
> 此《攻击面调查计划》是基于前期分析得出的初步指引，旨在为后续的白盒代码审计提供一个结构化的起点和重点关注区域。后续审计人员/Agent 在执行此计划时，应充分发挥其专业判断和经验，结合对代码的实际深入分析，主动识别和调查计划中可能未详尽列出的潜在安全风险。本计划不应被视为审计范围的唯一限制。
> 鼓励审计执行者在发现新的、计划外的可疑点时，自主扩展审计范围，并记录这些额外的发现。

## 详细检查项

- [ ] CODE-REVIEW-ITEM-001: 认证与授权模块审计
    *   **目标代码/配置区域**: 
        *   `SecurityConfig.java`（Spring Security 配置）
        *   用户认证相关 Controller（如 `AuthController.java`）
        *   JWT 令牌生成与验证代码
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **主动缺陷**: JWT 实现缺陷（弱密钥、无效签名验证）
        2.  **主动缺陷**: 认证绕过漏洞
        3.  **被动缺失**: 密码策略薄弱（长度、复杂度要求）
        4.  **被动缺失**: 会话管理配置不当
    *   **建议的白盒代码审计方法/关注点**: 
        1.  检查 JWT 密钥生成与存储方式
        2.  验证所有 API 端点的权限控制注解（`@PreAuthorize`）
        3.  审查密码哈希算法实现（应使用 BCrypt 等强哈希）
        4.  检查会话超时设置和令牌刷新机制
    *   **部署上下文与优先级**: 认证模块是核心安全屏障。优先级：极高

- [x] CODE-REVIEW-ITEM-002: API 端点输入验证审计
    *   **目标代码/配置区域**: 
        *   所有 Controller 类（特别是用户输入处理端点）
        *   全局异常处理器（`GlobalExceptionHandler.java`）
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **主动缺陷**: SQL 注入漏洞
        2.  **主动缺陷**: 跨站脚本（XSS）漏洞
        3.  **主动缺陷**: 路径遍历漏洞
        4.  **被动缺失**: 缺乏输入验证或验证不充分
    *   **建议的白盒代码审计方法/关注点**: 
        1.  检查用户输入是否直接拼接到 SQL 查询中
        2.  验证输出编码实现（特别是 HTML/JSON 输出）
        3.  审查文件操作相关的路径净化处理
        4.  检查 `@Valid` 注解使用和验证规则定义
    *   **部署上下文与优先级**: 所有外部请求入口点。优先级：高

- [ ] CONFIG-REVIEW-ITEM-003: 数据库连接配置审计
    *   **目标代码/配置区域**: 
        *   `application.yml` 数据库配置部分
        *   数据源初始化代码
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **主动缺陷/被动缺失**: JDBC URL 危险参数（`allowMultiQueries=true`）
        2.  **被动缺失**: 数据库凭证硬编码
        3.  **被动缺失**: 使用过高权限数据库账户
    *   **建议的白盒代码审计/配置审查方法/关注点**: 
        1.  检查 JDBC URL 是否存在危险参数
        2.  验证敏感凭证是否通过环境变量注入
        3.  审查数据库账户权限是否遵循最小权限原则
    *   **部署上下文与优先级**: 数据库直接暴露在公网。优先级：极高

- [ ] CODE-REVIEW-ITEM-004: Redis 安全配置审计
    *   **目标代码/配置区域**: 
        *   Redis 配置类（`RedisConfig.java`）
        *   `application.yml` Redis 配置部分
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **被动缺失**: 未启用身份验证
        2.  **被动缺失**: 敏感数据存储未加密
        3.  **主动缺陷**: 反序列化漏洞风险
    *   **建议的白盒代码审计方法/关注点**: 
        1.  检查 Redis 连接是否配置密码认证
        2.  验证敏感数据（如会话令牌）是否加密存储
        3.  审查反序列化操作的安全防护
    *   **部署上下文与优先级**: Redis 直接暴露在公网。优先级：极高

- [ ] CONFIG-REVIEW-ITEM-005: Spring Boot Actuator 安全审计
    *   **目标代码/配置区域**: 
        *   `application.yml` Actuator 配置部分
        *   安全框架对 Actuator 端点的保护
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **被动缺失**: 敏感端点未授权访问
        2.  **被动缺失**: 未禁用危险端点（env, heapdump）
    *   **建议的白盒代码审计/配置审查方法/关注点**: 
        1.  检查 Actuator 端点暴露情况
        2.  验证敏感端点是否受到安全框架保护
        3.  审查生产环境是否禁用危险端点
    *   **部署上下文与优先级**: 信息泄露风险。优先级：中高

- [ ] CODE-REVIEW-ITEM-006: 文件操作安全审计
    *   **目标代码/配置区域**: 
        *   文件上传/下载相关 Controller
        *   文件处理工具类
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **主动缺陷**: 路径遍历漏洞
        2.  **主动缺陷**: 未限制文件类型/大小
        3.  **主动缺陷**: 恶意文件上传风险
    *   **建议的白盒代码审计方法/关注点**: 
        1.  检查文件路径拼接操作
        2.  验证文件类型白名单实现
        3.  审查文件内容安全检查机制
    *   **部署上下文与优先级**: 文件处理功能。优先级：中

- [ ] CODE-REVIEW-ITEM-007: 依赖库安全审计
    *   **目标代码/配置区域**: 
        *   `pom.xml` 依赖声明
        *   第三方库使用代码
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **被动缺失**: 包含已知漏洞的依赖库
        2.  **主动缺陷**: 不安全库功能使用方式
    *   **建议的白盒代码审计方法/关注点**: 
        1.  扫描依赖库的已知漏洞（如 Log4j, Fastjson）
        2.  检查敏感操作库的使用方式（如 XML 解析）
    *   **部署上下文与优先级**: 第三方库风险。优先级：高

- [ ] CONFIG-REVIEW-ITEM-008: HTTP 安全头配置审计
    *   **目标代码/配置区域**: 
        *   安全过滤器配置
        *   `application.yml` 安全相关配置
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **被动缺失**: 缺少关键安全头（CSP, HSTS, XSS 防护）
        2.  **被动缺失**: CORS 配置过于宽松
    *   **建议的白盒代码审计/配置审查方法/关注点**: 
        1.  检查安全头配置实现
        2.  验证 CORS 策略是否最小化
    *   **部署上下文与优先级**: Web 应用基础防护。优先级：中

- [ ] CODE-REVIEW-ITEM-009: 业务逻辑漏洞审计
    *   **目标代码/配置区域**: 
        *   核心业务 Service 实现类
        *   支付/订单相关功能（如存在）
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **主动缺陷**: 越权访问漏洞（水平/垂直）
        2.  **主动缺陷**: 业务流程绕过漏洞
        3.  **主动缺陷**: 并发竞争条件
    *   **建议的白盒代码审计方法/关注点**: 
        1.  检查资源访问权限验证逻辑
        2.  验证关键业务流程的状态检查
        3.  审查高并发操作的同步机制
    *   **部署上下文与优先级**: 核心业务功能。优先级：高

- [ ] CONFIG-REVIEW-ITEM-010: 日志与错误处理审计
    *   **目标代码/配置区域**: 
        *   日志配置文件（`logback-spring.xml`）
        *   全局异常处理器
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **被动缺失**: 敏感信息泄露（日志记录凭证/令牌）
        2.  **被动缺失**: 详细错误信息暴露
    *   **建议的白盒代码审计/配置审查方法/关注点**: 
        1.  检查日志格式是否包含敏感数据
        2.  验证生产环境错误处理机制
    *   **部署上下文与优先级**: 信息泄露风险。优先级：中

## 结论与通用审计提醒

**重要提醒**：除本计划列出的具体检查项外，执行审计的人员/Agent 必须运用其全面的安全知识体系，参考最新的行业标准（如OWASP Top 10系列、CWE Top 25等）、特定技术的安全最佳实践以及自身的专业判断，进行彻底审查。本计划旨在提供重点，而非限定全部范围，鼓励主动发现和深入挖掘。

特别注意事项：
1. MySQL 和 Redis 直接暴露在公网，需特别关注其连接配置安全
2. Nginx 配置简单，需验证是否提供足够的安全防护
3. 关注 JWT 实现细节，防止认证绕过漏洞
4. 所有用户输入点都应视为潜在攻击入口
5. 审计时应考虑公网暴露组件的攻击场景