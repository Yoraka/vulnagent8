# LangFlow 攻击面调查计划 (白盒代码审计)

## 引言/概述

本计划基于前期《部署架构报告》分析结果和用户提供的项目上下文制定，特别关注：
1. API端点安全
2. 数据流漏洞
3. 第三方依赖风险

项目类型为应用层项目（FastAPI后端 + Streamlit前端），因此审计将同时关注主动缺陷（代码逻辑错误）和被动缺失（安全配置问题）。根据项目规模，计划包含10个核心检查项。

**声明**: 
> 此《攻击面调查计划》是基于前期分析得出的初步指引，旨在为后续的白盒代码审计提供一个结构化的起点和重点关注区域。后续审计人员/Agent 在执行此计划时，应充分发挥其专业判断和经验，结合对代码的实际深入分析，主动识别和调查计划中可能未详尽列出的潜在安全风险。本计划不应被视为审计范围的唯一限制。
> 鼓励审计执行者在发现新的、计划外的可疑点时，自主扩展审计范围，并记录这些额外的发现。

## 详细检查项

- [ ] API-REVIEW-ITEM-001: FastAPI端点安全审计
    *   **目标代码/配置区域**: 
        *   `api/`目录下所有路由文件
        *   FastAPI主应用文件（如`main.py`或`server.py`）
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **主动缺陷**: 未经验证的API端点
        2.  **主动缺陷**: 参数注入漏洞（SQL注入、命令注入）
        3.  **被动缺失**: CORS配置不当
        4.  **主动缺陷**: 敏感信息泄露（错误处理不当）
    *   **建议的白盒代码审计方法/关注点**: 
        1.  检查每个API端点的认证装饰器使用情况
        2.  分析所有输入参数的处理流程（特别关注直接拼接SQL或命令的部分）
        3.  审查CORS中间件配置（来源、方法、头部）
        4.  验证全局异常处理是否过滤敏感堆栈信息

- [ ] DATAFLOW-REVIEW-ITEM-002: 数据流处理漏洞审计
    *   **目标代码/配置区域**: 
        *   `core/`目录下数据处理模块
        *   `agents/`目录中AI代理处理逻辑
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **主动缺陷**: 不安全的反序列化操作
        2.  **主动缺陷**: 路径遍历漏洞（文件操作）
        3.  **主动缺陷**: SSRF（服务器端请求伪造）风险
        4.  **主动缺陷**: 敏感数据未脱敏
    *   **建议的白盒代码审计方法/关注点**: 
        1.  检查所有反序列化点（特别是用户可控输入）
        2.  审计文件操作函数（open/Path等）的路径净化逻辑
        3.  验证网络请求函数（requests/aiohttp）是否允许用户控制目标URL
        4.  审查日志输出和API响应中的敏感数据暴露

- [ ] DEPENDENCY-REVIEW-ITEM-003: 第三方依赖风险审计
    *   **目标代码/配置区域**: 
        *   `pyproject.toml`依赖声明
        *   `requirements.txt`依赖列表
        *   Dockerfile中的安装命令
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **被动缺失**: 已知漏洞依赖版本（CVE）
        2.  **被动缺失**: 不安全的直接依赖链
        3.  **主动缺陷**: 依赖混淆攻击风险
        4.  **被动缺失**: 过宽的依赖版本范围
    *   **建议的白盒代码审计方法/关注点**: 
        1.  使用安全工具扫描依赖（如safety、trivy）
        2.  检查关键依赖（如FastAPI、SQLAlchemy）的版本是否存在已知漏洞
        3.  验证私有包索引配置（防止依赖混淆）
        4.  审查版本锁定机制

- [ ] AUTH-REVIEW-ITEM-004: 认证授权机制审计
    *   **目标代码/配置区域**: 
        *   `core/security.py`（如存在）
        *   JWT/OAuth相关实现
        *   `OPENAI_API_KEY`等密钥管理代码
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **主动缺陷**: 认证绕过漏洞
        2.  **被动缺失**: 弱密码策略
        3.  **主动缺陷**: JWT实现缺陷
        4.  **被动缺失**: 密钥硬编码
    *   **建议的白盒代码审计方法/关注点**: 
        1.  测试权限检查的边界情况
        2.  检查密码强度验证逻辑
        3.  验证JWT签名算法和密钥管理
        4.  搜索代码中的硬编码凭证

- [ ] DB-REVIEW-ITEM-005: 数据库交互安全审计
    *   **目标代码/配置区域**: 
        *   SQLAlchemy ORM使用点
        *   原生SQL查询语句
        *   `database_url`配置（如`.env`）
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **主动缺陷**: SQL注入漏洞
        2.  **被动缺失**: 数据库连接池配置不当
        3.  **主动缺陷**: 敏感数据未加密
        4.  **被动缺失**: 生产环境使用弱凭证
    *   **建议的白盒代码审计方法/关注点**: 
        1.  检查所有原始SQL查询的用户输入处理
        2.  审查连接池大小和超时设置
        3.  验证敏感字段（如密码）是否加密存储
        4.  检查数据库连接字符串的安全性

- [ ] CONFIG-REVIEW-ITEM-006: 安全配置审计
    *   **目标代码/配置区域**: 
        *   `.env`环境配置文件
        *   Dockerfile安全设置
        *   `docker-compose.yml`配置
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **被动缺失**: 调试模式在生产环境启用
        2.  **被动缺失**: 容器以root权限运行
        3.  **被动缺失**: 敏感环境变量暴露
        4.  **被动缺失**: 不必要的端口暴露
    *   **建议的白盒代码审计方法/关注点**: 
        1.  验证生产环境禁用调试模式
        2.  检查Dockerfile中的USER指令
        3.  审查环境变量中的敏感信息
        4.  确认仅暴露必要端口

- [ ] LOGGING-REVIEW-ITEM-007: 日志安全审计
    *   **目标代码/配置区域**: 
        *   日志记录配置
        *   日志输出点
        *   错误处理中间件
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **主动缺陷**: 敏感信息日志泄露
        2.  **被动缺失**: 日志注入漏洞
        3.  **被动缺失**: 日志级别配置不当
    *   **建议的白盒代码审计方法/关注点**: 
        1.  检查日志中是否包含敏感数据（凭证、PII）
        2.  验证用户输入在日志中的净化处理
        3.  审查生产环境日志级别设置

- [ ] FILE-REVIEW-ITEM-008: 文件操作安全审计
    *   **目标代码/配置区域**: 
        *   文件上传/下载端点
        *   临时文件处理逻辑
        *   文件解析代码（如`pypdf`）
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **主动缺陷**: 路径遍历漏洞
        2.  **主动缺陷**: 不安全的临时文件
        3.  **主动缺陷**: 恶意文件上传风险
    *   **建议的白盒代码审计方法/关注点**: 
        1.  检查文件路径拼接逻辑
        2.  验证临时文件的权限和清理机制
        3.  审查文件类型验证和内容扫描

- [ ] AGENT-REVIEW-ITEM-009: AI代理安全审计
    *   **目标代码/配置区域**: 
        *   `agents/`目录中的AI代理实现
        *   LangChain集成点
        *   Prompt注入防护
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **主动缺陷**: Prompt注入漏洞
        2.  **主动缺陷**: 未受控的代码执行
        3.  **被动缺失**: 不合理的权限分配
    *   **建议的白盒代码审计方法/关注点**: 
        1.  测试用户输入对AI行为的影响
        2.  审查沙箱执行机制（如存在）
        3.  验证代理的最小权限原则实现

- [ ] DEPLOY-REVIEW-ITEM-010: 部署配置审计
    *   **目标代码/配置区域**: 
        *   `Dockerfile`构建指令
        *   `docker-compose.yml`服务配置
        *   CI/CD配置文件（如存在）
    *   **要审计的潜在风险/漏洞类型**: 
        1.  **被动缺失**: 包含敏感信息的构建上下文
        2.  **被动缺失**: 使用过时的基础镜像
        3.  **被动缺失**: 不安全的卷挂载
    *   **建议的白盒代码审计方法/关注点**: 
        1.  检查.dockerignore文件完整性
        2.  验证基础镜像版本和更新频率
        3.  审查卷挂载的权限和必要性

## 结论与通用审计提醒

**重要提醒**：除本计划列出的具体检查项外，执行审计的人员/Agent 必须运用其全面的安全知识体系，参考最新的行业标准（如OWASP Top 10系列、CWE Top 25等）、特定技术的安全最佳实践以及自身的专业判断，进行彻底审查。本计划旨在提供重点，而非限定全部范围，鼓励主动发现和深入挖掘。

特别建议：
1. 结合OWASP API Security Top 10审查API端点
2. 使用SAST工具辅助代码漏洞扫描
3. 针对AI代理特有的安全风险进行专项测试
4. 验证所有外部集成点的安全配置