# 攻击面调查计划 (Attack Surface Investigation Plan)

## 引言/概述

本计划基于以下信息制定：
1. **部署架构报告**：Dify 是一个开源的LLM应用开发平台，采用Python/FastAPI后端和React前端，使用Docker Compose部署。
2. **用户上下文**：审计目标是位于 `/data/dify/` 的Dify项目。
3. **技术栈分析**：
   - 后端框架：FastAPI (v0.115.12)
   - ORM：SQLAlchemy (v2.0.39)
   - 异步处理：Celery
   - 数据库：PostgreSQL
   - 前端框架：React
   - 反向代理：Nginx

**审计策略**：作为应用层项目，本计划将同等关注主动缺陷和被动缺失：
- **主动缺陷**：代码逻辑错误可能导致直接漏洞利用（如注入、越权）
- **被动缺失**：配置不当或设计选择可能增加攻击面（如默认配置过松、权限过大）

此《攻击面调查计划》是基于前期分析得出的初步指引，旨在为后续的白盒代码审计提供一个结构化的起点和重点关注区域。后续审计人员/Agent 在执行此计划时，应充分发挥其专业判断和经验，结合对代码的实际深入分析，主动识别和调查计划中可能未详尽列出的潜在安全风险。本计划不应被视为审计范围的唯一限制。

鼓励审计执行者在发现新的、计划外的可疑点时，自主扩展审计范围，并记录这些额外的发现。

## 详细检查项

### 后端核心安全审计

- [ ] CODE-REVIEW-ITEM-001: API端点输入验证与处理
  * **目标代码/配置区域**: 
    * `api/controllers/` 目录下所有端点处理函数
    * FastAPI路径操作函数（特别是处理用户输入的端点）
  * **要审计的潜在风险/漏洞类型**: 
    1. **主动缺陷**: 注入漏洞（SQL注入、命令注入）
    2. **主动缺陷**: 不安全的反序列化
    3. **主动缺陷**: 路径遍历（文件操作相关端点）
    4. **被动缺失**: 缺少输入验证或验证不充分
  * **建议的白盒代码审计方法/关注点**: 
    1. 检查所有用户输入点是否使用FastAPI的验证功能（Pydantic模型）
    2. 追踪用户输入在业务逻辑中的传播路径
    3. 检查文件操作函数是否对用户提供的路径进行规范化验证
    4. 验证SQLAlchemy查询是否使用参数化查询
  * **部署上下文与优先级**: API是核心业务入口，优先级：极高

- [ ] CODE-REVIEW-ITEM-002: 认证与授权机制
  * **目标代码/配置区域**: 
    * 认证中间件实现（如 `api/middleware/auth.py`）
    * 权限检查逻辑（角色/权限系统）
    * `application.yml` 或 `.env` 中的安全配置
  * **要审计的潜在风险/漏洞类型**: 
    1. **主动缺陷**: 认证绕过漏洞
    2. **主动缺陷**: 权限提升漏洞
    3. **被动缺失**: JWT实现缺陷（弱密钥、过期时间过长）
    4. **被动缺失**: 会话管理配置不当
  * **建议的白盒代码审计方法/关注点**: 
    1. 验证认证中间件是否在所有需要保护的端点前执行
    2. 检查权限检查是否在业务逻辑开始时执行
    3. 审计JWT密钥生成、存储和使用方式
    4. 检查密码存储是否使用强哈希算法（如bcrypt）
  * **部署上下文与优先级**: 安全核心组件，优先级：极高

- [ ] CODE-REVIEW-ITEM-003: LLM相关功能安全
  * **目标代码/配置区域**: 
    * 提示词处理逻辑
    * 模型调用接口
    * 输出处理函数
  * **要审计的潜在风险/漏洞类型**: 
    1. **主动缺陷**: 提示注入漏洞
    2. **主动缺陷**: 敏感信息泄露（通过模型输出）
    3. **被动缺失**: 缺乏输出内容过滤
    4. **被动缺失**: 模型访问控制缺失
  * **建议的白盒代码审计方法/关注点**: 
    1. 检查用户提供的提示词是否经过安全过滤
    2. 验证模型输出是否经过敏感信息过滤
    3. 审计模型访问权限控制机制
    4. 检查是否存在未授权模型访问路径
  * **部署上下文与优先级**: LLM核心功能，优先级：高

### 数据处理与存储审计

- [ ] CODE-REVIEW-ITEM-004: 数据库操作安全
  * **目标代码/配置区域**: 
    * `api/models/` ORM模型定义
    * `api/services/` 数据库操作逻辑
    * `.env` 数据库连接配置
  * **要审计的潜在风险/漏洞类型**: 
    1. **主动缺陷**: SQL注入（ORM使用不当）
    2. **被动缺失**: 数据库连接配置不安全（明文密码）
    3. **被动缺失**: 过度数据权限（ORM关系定义过松）
    4. **主动缺陷**: 敏感数据未加密存储
  * **建议的白盒代码审计方法/关注点**: 
    1. 检查所有SQLAlchemy查询是否使用参数化
    2. 验证.env中数据库密码是否加密存储
    3. 审计模型关系定义是否遵循最小权限原则
    4. 检查敏感字段（如API密钥）是否加密存储
  * **部署上下文与优先级**: 数据存储核心，优先级：高

- [ ] CODE-REVIEW-ITEM-005: 文件上传与处理
  * **目标代码/配置区域**: 
    * 文件上传端点
    * 文件处理服务
    * 临时文件处理逻辑
  * **要审计的潜在风险/漏洞类型**: 
    1. **主动缺陷**: 未限制文件类型导致恶意文件上传
    2. **主动缺陷**: 解压缩路径遍历漏洞
    3. **主动缺陷**: 文件处理命令注入
    4. **被动缺失**: 文件存储权限配置不当
  * **建议的白盒代码审计方法/关注点**: 
    1. 检查文件类型验证逻辑（MIME类型+扩展名）
    2. 审计解压缩操作是否验证目标路径
    3. 检查文件处理命令是否使用参数化调用
    4. 验证文件存储目录权限设置
  * **部署上下文与优先级**: 文件处理功能，优先级：中高

### 配置与基础设施审计

- [ ] CONFIG-REVIEW-ITEM-006: 环境配置安全
  * **目标代码/配置区域**: 
    * `.env` 配置文件
    * `docker-compose.yml`
    * FastAPI初始化配置
  * **要审计的潜在风险/漏洞类型**: 
    1. **被动缺失**: 敏感信息硬编码
    2. **被动缺失**: 调试模式在生产环境启用
    3. **被动缺失**: CORS配置过于宽松
    4. **被动缺失**: 日志包含敏感信息
  * **建议的白盒代码审计/配置审查方法/关注点**: 
    1. 检查.env中是否存在硬编码密码/密钥
    2. 验证生产环境是否禁用调试模式
    3. 审计CORS配置是否遵循最小来源原则
    4. 检查日志格式是否包含敏感数据
  * **部署上下文与优先级**: 基础安全配置，优先级：高

- [ ] CODE-REVIEW-ITEM-007: 第三方依赖安全
  * **目标代码/配置区域**: 
    * `requirements.txt`
    * `package.json` (前端)
    * 实际导入的第三方库
  * **要审计的潜在风险/漏洞类型**: 
    1. **被动缺失**: 包含已知漏洞的依赖
    2. **被动缺失**: 过度依赖权限
    3. **主动缺陷**: 不安全依赖使用方式
  * **建议的白盒代码审计方法/关注点**: 
    1. 使用SCA工具扫描已知漏洞
    2. 人工审查关键依赖的导入和使用方式
    3. 检查依赖权限是否遵循最小化原则
  * **部署上下文与优先级**: 供应链安全，优先级：中

- [ ] CODE-REVIEW-ITEM-008: 异步任务安全
  * **目标代码/配置区域**: 
    * Celery任务定义 (`workers/`)
    * 任务队列配置
    * 任务结果处理
  * **要审计的潜在风险/漏洞类型**: 
    1. **主动缺陷**: 任务参数注入
    2. **被动缺失**: 任务结果未安全存储
    3. **被动缺失**: 任务优先级处理缺陷
  * **建议的白盒代码审计方法/关注点**: 
    1. 检查任务参数是否经过验证
    2. 审计任务结果存储的安全性
    3. 验证敏感任务是否适当隔离
  * **部署上下文与优先级**: 后台任务处理，优先级：中

### 前端安全审计

- [ ] CODE-REVIEW-ITEM-009: 客户端安全控制
  * **目标代码/配置区域**: 
    * 前端认证状态管理
    * API调用封装
    * 用户输入处理
  * **要审计的潜在风险/漏洞类型**: 
    1. **主动缺陷**: XSS漏洞
    2. **被动缺失**: 敏感信息客户端存储
    3. **被动缺失**: CSRF防护缺失
  * **建议的白盒代码审计方法/关注点**: 
    1. 检查所有用户输入渲染点是否编码
    2. 审计localStorage/sessionStorage使用
    3. 验证API调用是否包含CSRF令牌
  * **部署上下文与优先级**: 客户端安全，优先级：中高

## 结论与通用审计提醒

**重要提醒**：除本计划列出的具体检查项外，执行审计的人员/Agent 必须运用其全面的安全知识体系，参考最新的行业标准（如OWASP Top 10系列、CWE Top 25等）、特定技术的安全最佳实践以及自身的专业判断，进行彻底审查。本计划旨在提供重点，而非限定全部范围，鼓励主动发现和深入挖掘。

特别建议关注：
- LLM特有的安全风险（提示注入、训练数据泄露）
- 供应链安全（第三方依赖、模型权重）
- 配置安全（环境变量、部署配置）
- 隐私保护（GDPR/CCPA合规性）